@if (personStore.isReady()) {
  <div class="main-container-header">
    @if (personStore.inCreateMode()) {
      <h2>Create Person</h2>
    } @else if (personStore.inEditMode()) {
      <h2>Edit Person</h2>
    } @else {
      <h2>View Person</h2>
    }

    <div class="icons-container">
      @if (!personStore.inCreateMode()) {
        <button
          mat-icon-button
          [disabled]="personStore.inEditMode()"
          (click)="personStore.toggleEditMode()"
        >
          <mat-icon aria-label="Edit person icon">edit</mat-icon>
        </button>
        <button mat-icon-button (click)="onDelete()">
          <mat-icon aria-label="Delete person icon">delete_forever</mat-icon>
        </button>
      }
    </div>
  </div>

  <form [formGroup]="personForm">
    @if (personStore.isErrored()) {
      <aw-error-container [errors]="personStore.errors()" />
    }

    <mat-form-field>
      <mat-label>Given Name</mat-label>
      <input matInput placeholder="Name" formControlName="givenName" />
      @if (personForm.controls.givenName.hasError('required')) {
        <mat-error>
          Given Name is
          <strong>required</strong>
        </mat-error>
      }
    </mat-form-field>

    <mat-form-field>
      <mat-label>Family Name</mat-label>
      <input matInput placeholder="Name" formControlName="familyName" />
      @if (personForm.controls.familyName.hasError('required')) {
        <mat-error>
          Family Name is
          <strong>required</strong>
        </mat-error>
      }
    </mat-form-field>

    <mat-form-field>
      <mat-label>Person Type</mat-label>
      <mat-select
        formControlName="personType"
        [compareWith]="comparePersonTypes"
      >
        @for (personType of personStore.personTypes(); track personType.id) {
          <mat-option [value]="personType">
            {{ personType.name }}
          </mat-option>
        }
      </mat-select>
      @if (personForm.controls.personType.hasError('required')) {
        <mat-error>
          Person Type is
          <strong>required</strong>
        </mat-error>
      }
    </mat-form-field>

    <mat-form-field class="tags-chip-list">
      <mat-label>Tags</mat-label>
      <mat-chip-grid #chipGrid aria-label="Tag selection">
        @for (tag of personStore.sortedTags(); track $index) {
          <mat-chip-row (removed)="personStore.removeTag(tag)">
            {{ tag.pathname }}
            <button matChipRemove [attr.aria-label]="'remove ' + tag">
              <mat-icon>cancel</mat-icon>
            </button>
          </mat-chip-row>
        }
      </mat-chip-grid>
      <input
        placeholder="Enter new tag and/or search..."
        type="text"
        formControlName="searchTag"
        [value]="personStore.searchText() ?? ''"
        [matChipInputFor]="chipGrid"
        [matAutocomplete]="auto"
        [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
        (matChipInputTokenEnd)="add($event)"
      />
      <mat-autocomplete
        #auto="matAutocomplete"
        (optionSelected)="selected($event)"
      >
        @if (personStore.filteredTags()) {
          @for (tag of personStore.filteredTags(); track tag.id) {
            <mat-option [value]="tag.pathname">{{ tag.pathname }}</mat-option>
          }
        }
      </mat-autocomplete>
    </mat-form-field>

    <div class="form-button-container">
      <button
        mat-button
        type="button"
        (click)="onCancel()"
        class="default-button"
        [disabled]="!personStore.inEditMode()"
      >
        Cancel
      </button>
      <button
        mat-flat-button
        type="submit"
        class="default-button"
        [disabled]="
          !personStore.inEditMode() || !personForm.valid || !personForm.dirty
        "
      >
        Save
      </button>
    </div>
  </form>
}
